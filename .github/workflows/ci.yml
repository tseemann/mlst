name: CI

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  test:
    runs-on: ubuntu-latest

    permissions:
      contents: read

    env:
      BLASTVER: 2.9.0
      CACHEDIR: tarballs

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Perl
      uses: shogo82148/actions-setup-perl@v1
      with:
        perl-version: '5.26'

    - name: Cache BLAST+ tarball
      uses: actions/cache@v3
      with:
        path: ${{ env.CACHEDIR }}
        key: blast-${{ env.BLASTVER }}

    - name: Install Perl dependencies
      run: cpanm --quiet --notest Moo JSON List::MoreUtils

    - name: Create cache directory
      run: mkdir -p $CACHEDIR

    - name: Download BLAST+
      run: wget -N -c -P $CACHEDIR http://ftp.ncbi.nlm.nih.gov/blast/executables/blast+/${BLASTVER}/ncbi-blast-${BLASTVER}+-x64-linux.tar.gz

    - name: Extract BLAST+
      run: tar zxvf $CACHEDIR/ncbi-blast-${BLASTVER}+-x64-linux.tar.gz

    - name: Download any2fasta
      run: |
        mkdir -p bin
        curl https://raw.githubusercontent.com/tseemann/any2fasta/master/any2fasta > bin/any2fasta
        chmod +x bin/any2fasta

    - name: Set up PATH
      run: echo "$PWD/bin:$PWD/ncbi-blast-${BLASTVER}+/bin" >> $GITHUB_PATH

    - name: Test mlst --check
      run: mlst --check

    - name: Test mlst --version
      run: mlst --version

    - name: Test mlst --help
      run: mlst --help

    - name: Test invalid option
      run: "! mlst --doesnotexist"

    - name: Test invalid directory /etc
      run: "! mlst -q /etc"

    - name: Test invalid file /etc/shadow
      run: "! mlst -q /etc/shadow"

    - name: Test list scheme (saureus)
      run: mlst --list | grep saureus

    - name: Test longlist scheme (saureus)
      run: mlst --longlist | grep saureus

    - name: Test example.fna.gz
      run: mlst -q test/example.fna.gz | grep -w 184

    - name: Test example.gbk.gz
      run: mlst -q test/example.gbk.gz | grep -w 184

    - name: Test novel.fasta.bz2
      run: mlst -q test/novel.fasta.bz2 | grep -w spneumoniae

    - name: Test stdin with fna.gz
      run: gzip -d -c test/example.fna.gz | mlst -q /dev/stdin | grep -w 184

    - name: Test stdin with gbk.gz
      run: gzip -d -c test/example.gbk.gz | mlst -q /dev/stdin | grep -w 184

    - name: Test legacy scheme
      run: mlst -q --legacy --scheme sepidermidis test/example.fna.gz test/example.gbk.gz

    - name: Test CSV output
      run: mlst -q --csv test/example.fna.gz | grep ',184,'

    - name: Test JSON output
      run: mlst -q test/example.gbk.gz --json out.json && grep 'sequence_type' out.json

    - name: Test duplicate label (should fail)
      run: "! mlst -q --label double_trouble test/example.gbk.gz test/example.fna.gz"

    - name: Test custom label
      run: mlst -q --label GDAYMATE test/example.fna.gz | grep GDAYMATE

    - name: Test novel alleles
      run: mlst -q --novel novel.fa test/novel.fasta.bz2 && grep 'recP' novel.fa

    - name: Test mlst-show_seqs
      run: scripts/mlst-show_seqs -s efaecium -t 111
